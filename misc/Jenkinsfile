pipeline {
    agent any
    tools {
        nodejs "nodeJs"  // Global Tool Configuration에서 설정한 정확한 Node.js 이름 사용
    }
    environment {
        DOCKER_REGISTRY = 'https://index.docker.io/v2/'
        DOCKER_CREDENTIALS = 'dockerhub' // Jenkins의 Docker Hub 자격증명 ID
    }
    stages {
        stage('Preparation') {
            steps {
                script {
                    checkout scm
                    sh "git rev-parse --short HEAD > .git/commit-id"
                    env.COMMIT_ID = readFile('.git/commit-id').trim()

                    // Node.js 경로 추가
                    def nodejsTool = tool name: 'nodeJs', type: 'jenkins.plugins.nodejs.tools.NodeJSInstallation'
                    env.PATH = "${nodejsTool}/bin:${env.PATH}"
                }
            }
        }

        stage('Build') {
            steps {
                sh 'node -v'
                sh 'npm -v'
            }
        }

        stage('Docker Build & Push') {
            steps {
                script {
                    docker.withRegistry(env.DOCKER_REGISTRY, env.DOCKER_CREDENTIALS) {
                        docker.build("ejujin/docker-nodejs-demo:${env.COMMIT_ID}").push()
                    }
                }
            }
        }
    }
}
